name: CI  # lint + test matrix

on:
  pull_request:
    branches: ["main"]
  push:
    branches: ["main"]
  workflow_dispatch:  # manual runs from the Actions tab
  workflow_call:  # reusable workflow (used by release/publish pipeline)

permissions:
  contents: read  # checkout only

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}  # one run per ref (PR branch / main)
  cancel-in-progress: true

jobs:
  lint:  # fast failure for syntax/undefined names
    name: Lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: "3.11"
          cache: pip
          cache-dependency-path: pyproject.toml  # pip cache key

      - name: Install lint dependencies
        run: |
          python -m pip install --upgrade pip
          python -m pip install flake8

      - name: Lint with flake8
        run: |
          flake8 . --count --select=E9,F63,F7,F82 --max-line-length=79 --show-source --statistics

  tests:  # full unit/integration tests
    name: Tests (Python ${{ matrix.python-version }})
    runs-on: ${{ matrix.os }}
    needs: lint
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest] # , macos-latest, windows-latest]
        # When called from another workflow, run a single version to generate coverage+badges once.
        python-version: ${{ fromJSON(github.event_name == 'workflow_call' && '["3.11"]' || '["3.10","3.11","3.12","3.13"]') }}
        # exclude:
        #   - os: windows-latest
        #     python-version: "3.13"  # ray >= 2.6.0 not found
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: ${{ matrix.python-version }}
          cache: pip
          cache-dependency-path: pyproject.toml  # pip cache key

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          python -m pip install -e .  # install the package under test
          python -m pip install pytest

      - name: Install badge tooling
        if: ${{ github.event_name == 'workflow_call' && matrix.python-version == '3.11' }}
        run: |
          python -m pip install coverage==7.4.4 coverage-badge interrogate[png] cairosvg

      - name: Run tests (coverage)
        if: ${{ github.event_name == 'workflow_call' && matrix.python-version == '3.11' }}
        run: |
          mkdir -p .badges
          coverage run --source=mlwiz -m pytest -q
          coverage report -m
          coverage-badge -o .badges/coverage_badge.svg -f

      - name: Interrogate badge
        if: ${{ github.event_name == 'workflow_call' && matrix.python-version == '3.11' }}
        run: |
          interrogate -i -M --generate-badge .badges mlwiz

      - name: Upload badges
        if: ${{ github.event_name == 'workflow_call' && matrix.python-version == '3.11' }}
        uses: actions/upload-artifact@v4
        with:
          name: badges
          path: .badges/*.svg
          if-no-files-found: error

      - name: Run tests
        if: ${{ !(github.event_name == 'workflow_call' && matrix.python-version == '3.11') }}
        run: |
          pytest -q
